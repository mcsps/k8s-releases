# image: mtr.external.otc.telekomcloud.com/mcsps/mcsps-tools:latest
image: docker:latest
cache: {}

before_script:
 - apk add --update --no-cache findutils bash curl wget git jq openssh-client && apk upgrade
 - mkdir -p ~/.ssh/
 - ssh-keyscan github.com >> ~/.ssh/known_hosts
 - chmod 644 ~/.ssh/known_hosts
 - eval $(ssh-agent -s)
 - echo "$GITHUB_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
 - git config --global user.email 'mcsps-dis@telekom.de'
 - git config --global user.name 'Deploy User'
 - git remote set-url --push origin https://oauth2:$DEPLOY_TOKEN@gitlab.dol.telekom.de/mcsps/k8s-releases.git
 
variables:
  BRANCH: $CI_COMMIT_REF_NAME

stages:
  - fetchreleasenote

check-release:
  tags:
    - k8s-executor
  stage: fetchreleasenote
  script:
# sync to github
    -  git remote remove https://oauth2:$DEPLOY_TOKEN@gitlab.dol.telekom.de/mcsps/k8s-releases.git || true
    -  git remote remove github || true
    -  git remote add github git@github.com:mcsps/k8s-releases.git
    -  git remote -v
    -  git fetch github
    -  git push github --force HEAD:master || true
    -  exit 0
  # Release Notes Rancher
    -  ORG=rancher
    -  REPO=rancher
    -  RTAG=$(curl --silent "https://api.github.com/repos/${ORG}/${REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    -  DESC=$(curl --silent "https://api.github.com/repos/${ORG}/${REPO}/releases/latest" | jq .body)
    -  LTAG=$(git tag | sed 's/${REPO}-//' | tail -1 )
    -  echo "${LTAG}"
    -  >
       if [[ "$LTAG" != "$RTAG" ]]; then
         if ! git tag | grep ${REPO}-${RTAG}; then
           git tag ${REPO}-${RTAG} 
           git push origin --tags
           echo -en ${DESC} > ${REPO}/${RTAG}.md
           sed -i 's/"//g' ${REPO}/${RTAG}.md
           sed -i 's/\\r//g' ${REPO}/${RTAG}.md
           git add ${REPO}/${RTAG}.md
           git commit -m "add release desc"
           git push origin HEAD:${BRANCH} || true
         fi
       else
         echo "Nothing to do ${REPO}"
       fi
  # Release Notes kubernetes
    -  ORG=kubernetes
    -  REPO=kubernetes
    -  RTAG=$(curl --silent "https://api.github.com/repos/${ORG}/${REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    -  DESC=$(curl --silent "https://api.github.com/repos/${ORG}/${REPO}/releases/latest" | jq .body)
    -  LTAG=$(git tag | sed 's/${REPO}-//' | tail -1 )
    -  >
       if [[ "$LTAG" != "$RTAG" ]]; then
         if ! git tag | grep ${REPO}-${RTAG}; then
           git tag ${REPO}-${RTAG} 
           git push origin --tags
           echo "# Release ${RTAG}" > ${REPO}/${RTAG}.md
           echo -en ${DESC} >> ${REPO}/${RTAG}.md
           sed -i 's/"//g' ${REPO}/${RTAG}.md
           sed -i 's/\\r//g' ${REPO}/${RTAG}.md
           git add ${REPO}/${RTAG}.md
           git commit -m "add release desc"
           git push origin HEAD:${BRANCH} || true
         fi
       else
         echo "Nothing to do ${REPO}"
       fi
  # Release Notes Terraform
    -  ORG=hashicorp
    -  REPO=terraform
    -  RTAG=$(curl --silent "https://api.github.com/repos/${ORG}/${REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    -  DESC=$(curl --silent "https://api.github.com/repos/${ORG}/${REPO}/releases/latest" | jq .body)
    -  LTAG=$(git tag | sed 's/${REPO}-//' | tail -1 )
    -  >
       if [[ "$LTAG" != "$RTAG" ]]; then
         if ! git tag | grep ${REPO}-${RTAG}; then
           git tag ${REPO}-${RTAG} 
           git push origin --tags
           echo "# Release ${RTAG}" > ${REPO}/${RTAG}.md
           echo -en ${DESC} >> ${REPO}/${RTAG}.md
           sed -i 's/"//g' ${REPO}/${RTAG}.md
           sed -i 's/\\r//g' ${REPO}/${RTAG}.md
           git add ${REPO}/${RTAG}.md
           git commit -m "add release desc"
           git push origin HEAD:${BRANCH} || true
         fi
       else
         echo "Nothing to do ${REPO}"
       fi
    -  cat tpl/1.rst > index.rst
    -  cat tpl/2.rst >> index.rst
    -  find kubernetes/ -name "*.md" -printf "   %p\n"  >> index.rst
    -  echo "" >> index.rst
    -  cat tpl/3.rst >> index.rst
    -  find rancher/ -name "*.md" -printf "   %p\n" >> index.rst
    -  echo "" >> index.rst
    -  cat tpl/4.rst >> index.rst
    -  find terraform/ -name "*.md" -printf "   %p\n" >> index.rst
    -  echo "" >> index.rst
    -  cat tpl/5.rst >> index.rst
    -  git add index.rst
    -  git commit -m "build index"
    -  git push origin --force HEAD:${BRANCH} || true
# sync to github
    # -  git remote remove https://oauth2:$DEPLOY_TOKEN@gitlab.dol.telekom.de/mcsps/k8s-releases.git || true
    # -  git remote remove github || true
    # -  git remote add github git@github.com:mcsps/k8s-releases.git
    # -  git remote -v
    # -  git fetch github
    # -  git push github --force HEAD:master || true
  except: 
    - tags
